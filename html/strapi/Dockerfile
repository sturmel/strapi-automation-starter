FROM node:20-alpine

# Installation des d√©pendances syst√®me
RUN apk add --no-cache \
    python3 \
    make \
    g++ \
    postgresql-client \
    git

# Cr√©ation du r√©pertoire de travail
WORKDIR /opt/app

# Cr√©ation de Strapi avec SQLite par d√©faut (plus simple)
RUN npx create-strapi-app@latest . --quickstart --no-run --skip-cloud

# Installation du driver PostgreSQL
RUN npm install pg

# Copie des fichiers de configuration apr√®s cr√©ation
COPY config/ ./config/

# Script de d√©marrage conditionnel
RUN echo '#!/bin/sh' > /opt/app/start.sh && \
    echo 'if [ "$NODE_ENV" = "production" ]; then' >> /opt/app/start.sh && \
    echo '  echo "üöÄ Starting Strapi in PRODUCTION mode"' >> /opt/app/start.sh && \
    echo '  npm run build' >> /opt/app/start.sh && \
    echo '  npm run start' >> /opt/app/start.sh && \
    echo 'else' >> /opt/app/start.sh && \
    echo '  echo "üîß Starting Strapi in DEVELOPMENT mode"' >> /opt/app/start.sh && \
    echo '  npm run develop' >> /opt/app/start.sh && \
    echo 'fi' >> /opt/app/start.sh && \
    chmod +x /opt/app/start.sh

# Exposition du port
EXPOSE 1337

# Commande de d√©marrage conditionnel
CMD ["/opt/app/start.sh"]
